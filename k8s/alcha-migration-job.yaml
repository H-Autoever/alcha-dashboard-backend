apiVersion: batch/v1
kind: Job
metadata:
  name: alcha-migration-job
  labels:
    app: alcha-migration
spec:
  template:
    metadata:
      labels:
        app: alcha-migration
    spec:
      restartPolicy: Never
      containers:
      - name: migration
        image: python:3.11-slim
        command: ["/bin/bash"]
        args:
          - -c
          - |
            # í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
            apt-get update && apt-get install -y \
              python3-pip \
              && rm -rf /var/lib/apt/lists/*
            
            # Python íŒ¨í‚¤ì§€ ì„¤ì¹˜
            pip3 install pymongo psycopg2-binary python-dotenv
            
            # ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
            cd /app
            
            # ë””ë ‰í† ë¦¬ êµ¬ì¡° í™•ì¸
            ls -la
            
            # ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
            echo "ğŸš€ MongoDB â†’ TimescaleDB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘..."
            python3 migrate_mongodb_to_timescaledb.py
        env:
        # MongoDB ì—°ê²° ì •ë³´
        - name: MONGO_HOST
          value: "alcha-mongo"
        - name: MONGO_PORT
          value: "27017"
        - name: MONGO_DB
          value: "vehicle_data_db"
        - name: MONGO_USER
          value: "admin"
        - name: MONGO_PASSWORD
          value: "admin_password"
        - name: MONGO_AUTH_DB
          value: "admin"
        # TimescaleDB ì—°ê²° ì •ë³´
        - name: TIMESCALEDB_HOST
          value: "alcha-timescaledb"
        - name: TIMESCALEDB_PORT
          value: "5432"
        - name: TIMESCALEDB_DB
          value: "alcha_events"
        - name: TIMESCALEDB_USER
          value: "alcha"
        - name: TIMESCALEDB_PASSWORD
          value: "alcha_password"
        volumeMounts:
        - name: app-code
          mountPath: /app
      volumes:
      - name: app-code
        configMap:
          name: alcha-migration-config
  backoffLimit: 3
